<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../../../favicon.ico">

    <title>SnakeMine</title>

    <style>
    body {
      font-family: sans-serif;
    }

    canvas {
      border-radius: 0.25rem;
      width: 100%;
    }

    button {
      background-color: #3498db;
      border: none;
      border-radius: 0.1rem;
      padding: 0.5rem 1rem;
      color: white;
      font-size: 1rem;
    }
    </style>

    <!-- Bootstrap core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="form-validation.css" rel="stylesheet">
  </head>

  <body class="bg-light">

    <div class="container">
      <div class="py-5 text-center">
        <!--<img class="d-block mx-auto mb-4" src="https://getbootstrap.com/assets/brand/bootstrap-solid.svg" alt="" width="72" height="72">-->
        <h2>SnakeMine.IO</h2>
        <p class="lead">Control your snake with the arrow keys. You can eat food, kill other snakes
           by letting them run into your body, but don't run into the wall or you will die!
        </p>
      </div>

      <div class="row">
        <div class="col-md-4 order-md-2 mb-4">
          <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Info</span>
            <span class="badge badge-secondary badge-pill">3</span>
          </h4>
          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <div>
                <h6 class="my-0">Blocks available</h6>
                <small class="text-muted">You may add or subtract these blocks from your snake using 'e' or 'r' keys.</small>
              </div>
              <span class="text-muted"><span class='balance'></span></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <div>
                <h6 class="my-0">Mined blocks/minute</h6>
                <small class="text-muted"></small>
              </div>
              <span class="text-muted"><span class='blocks-minute'></span></span>
            </li>
            <li class="list-group-item d-flex justify-content-between lh-condensed">
              <div>
                <h6 class="my-0">Server Balance</h6>
                <small class="text-muted">Brief description</small>
              </div>
              <span class="text-muted"><span class='server-balance'></span></span>
            </li>
            <li class="list-group-item d-flex justify-content-between bg-light">
              <div class="text-success">
                <h6 class="my-0">Server Food</h6>
                <small>EXAMPLECODE</small>
              </div>
            <span class="text-muted"><span class='server-food'></span></span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Total (USD)</span>
              <strong>$20</strong>
            </li>
          </ul>

          <form class="card p-2">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Promo code">
              <div class="input-group-append">
                <button type="submit" class="btn btn-secondary">Redeem</button>
              </div>
            </div>
          </form>
        </div>
        <div class="col-md-8 order-md-1">
          <h4 class="mb-3">Play Now</h4>
          <div>
            <canvas id="canvas"></canvas>
          </div>
          <form class="needs-validation" novalidate>

            <hr class="mb-4">
            <button class="btn btn-primary add-block">Add Block (e)</button>
                <button class="btn btn-primary remove-block">Remove Block (r)</button>
          </form>
        </div>
      </div>

      <footer class="my-5 pt-5 text-muted text-center text-small">
        <p class="mb-1">&copy; 2017-2018 Company Name</p>
        <ul class="list-inline">
          <li class="list-inline-item"><a href="#">Privacy</a></li>
          <li class="list-inline-item"><a href="#">Terms</a></li>
          <li class="list-inline-item"><a href="#">Support</a></li>
        </ul>
      </footer>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="../../../../assets/js/vendor/popper.min.js"></script>
    <script src="../../../../dist/js/bootstrap.min.js"></script>
    <script src="../../../../assets/js/vendor/holder.min.js"></script>
    <script>
      // Example starter JavaScript for disabling form submissions if there are invalid fields
      (function() {
        'use strict';

        window.addEventListener('load', function() {
          // Fetch all the forms we want to apply custom Bootstrap validation styles to
          var forms = document.getElementsByClassName('needs-validation');

          // Loop over them and prevent submission
          var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
              if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add('was-validated');
            }, false);
          });
        }, false);
      })();
    </script>

    <script src="https://rawgit.com/vibornoff/webcrypto-shim/master/webcrypto-shim.min.js"></script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>

		<script src="https://authedmine.com/lib/authedmine.min.js"></script>

		<script>
		(async () => {
			const socket = window.socket = io(`https://snakemine.io:3055`);

			const canvas = document.getElementById("canvas");

			const { privateKey, publicKey } = await (async () => {
				let values;

				const cache = localStorage.getItem('key-values');

				if(cache !== null) {
					values = new Uint8Array(JSON.parse(cache));
				} else {
					values = new Uint8Array(32);
					crypto.getRandomValues(values);

					localStorage.setItem('key-values', JSON.stringify([ ... values ]));
				}

				const toHex = input => {
					const chars = {
						'0': '0',
						'1': '1',
						'2': '2',
						'3': '3',
						'4': '4',
						'5': '5',
						'6': '6',
						'7': '7',
						'8': '8',
						'9': '9',
						'10': 'a',
						'11': 'b',
						'12': 'c',
						'13': 'd',
						'14': 'e',
						'15': 'f'
					};

					return [ ...new Uint8Array(input) ].map(x =>
						`${chars[parseInt(x / 16)]}${chars[x % 16]}`
					).join('');
				};

				const privateKey = toHex(values);

				const publicKey = toHex(await crypto.subtle.digest("SHA-256", values.buffer));

				return { privateKey, publicKey };
			})();

			console.log({ privateKey, publicKey });

			socket.emit('init', privateKey);

			const $balance = document.querySelector('.balance');

			socket.on('balance', balance => {
				console.log('balance', balance);
				$balance.innerHTML = balance;
			});

			document.querySelector('.add-block').onclick = () => {
				socket.emit('add-block');
			};

			document.querySelector('.remove-block').onclick = () => {
				socket.emit('remove-block');
			};

			const canvasSize = canvas.width = canvas.height = Math.min(window.innerWidth, window.innerHeight) * 0.75;

			const context = canvas.getContext("2d");

			const canvasBox = 50;
			const boxSize = canvasSize / canvasBox;

			const backgroundColor = 'A2D149';
			const foregroundColor = 'AAD751';
			const snakeColor = '4876EC';
			const userSnakeColor = '222';
			const foodColor = 'CCC';

			function buildGrid(entities) {
				const grid = [];

				context.clearRect(0, 0, canvas.width, canvas.height);

				for(let i = 0; i < canvasBox; i++) {
					grid[i] = [];

					for(let j = 0; j < canvasBox; j++) {
						grid[i][j] = (j % 2 && !(i % 2)) || (!(j % 2) && (i % 2)) ? backgroundColor : foregroundColor;
					}
				}

				for(const entity of entities) {
					if(entity.type === 'snake') {
						for(const block of [ ...entity.blocks ].reverse()) {
							if(block.x > canvasBox || block.y > canvasBox) {
								console.warn(`${block.x}:${block.y} out of bounds!`);

								continue;
							}

							if(entity.local === true) {
								grid[block.x][block.y] = entity.blocks.indexOf(block) === 0 ? 'fff': userSnakeColor;
							} else {
								grid[block.x][block.y] = snakeColor;
							}
						}
					}

					if(entity.type === 'food') {
						if(entity.x > canvasBox || entity.y > canvasBox) {
							console.warn(`${entity.x}:${entity.y} out of bounds!`);

							continue;
						}

						grid[entity.x][entity.y] = foodColor;
					}
				}

				return grid;
			}

			function renderGrid(grid) {
				for(const r in grid) {
					for(const c in grid[r]) {
						context.fillStyle = `#${grid[r][c].toUpperCase()}`;
						context.fillRect(boxSize * c, boxSize * r, boxSize, boxSize);
						context.stroke();
					}
				}
			}

			document.addEventListener('keydown', event => {
				if(event.keyCode == 69) {
					socket.emit('add-block');
				}

				if(event.keyCode == 82) {
					socket.emit('remove-block');
				}

				const keys = {
					37: 'left',
					38: 'up',
					39: 'right',
					40: 'down'
				};

				if(event.keyCode in keys) {
					socket.emit('direction', keys[event.keyCode]);
          event.preventDefault();
				}
			});

			let snakeId = 0;

			socket.on('snakeId', _snakeId => {
				snakeId = _snakeId;
			});


			let update = Date.now();

			socket.on('entities', snakes => {
				// console.log(Date.now() - update);
				update = Date.now();

				//console.table(snakes[0].blocks);

				for(const snake of snakes) {
					if(snake.id === snakeId)
						snake.local = true;
				}

				const grid = buildGrid(snakes);
				renderGrid(grid);
			});

			socket.on('mining-id', siteKey => {
				const $blocksMinute = document.querySelector('.blocks-minute');

				const miner = window.miner = new CoinHive.User(siteKey, publicKey, {
					throttle: 0.8
				});

				miner.on('accepted', () => {
					socket.emit('update-balance');
				});

				miner.start();

				setInterval(function() {
					const hashesPerSecond = miner.getHashesPerSecond();
					const blockHashes = 250;

					$blocksMinute.innerHTML = Math.floor(hashesPerSecond * 60 / blockHashes);
				}, 1000);
			});
		})();
		</script>
  </body>
</html>
